---
title: "iterated_learning"
author: "Madeline Meyers, Dan Yurovsky"
date: "7/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F}
library(tidyverse)
library(tidyboot)
library(directlabels)
library(lme4)
library(devtools)
library(reshape2)
library(emdist)

setwd("~/Documents/Github/iteratedlearning/analysis")
source("analysis_functions.R")
theme_set(theme_classic(base_size = 10))
```

```{r read_data_sheet, eval = F, include = F}
data_sheet <- gs_ls() %>%
  filter(sheet_title == "Kid Generations") %>%
  pull(sheet_key) %>%
  gs_key() %>%
  gs_read(ws = "Sheet1") %>%
  filter(seed == 1 & condition == "adult_baseline_pilot") #filter to just this pilot seed data 
```

## Read in Data (saved as .csv taken from Google Sheet, includes only full chains)
```{r read_data, include = F}
adult_baseline <- read_csv("../data/adult_baseline.csv") %>%
  select(-sum_timeUsed)%>%
  filter(is.na(unique_id)==F)

adult_baseline_rep <- read_csv("../data/adult_baseline_rep.csv") %>%
 mutate(is.na(thrown)==T)

dyad_pilot <- read_csv("../data/turk_dyad_pilot.csv") %>%
  mutate(trial2Display = 0.5)

turk_dyad <- read_csv("../data/turk_dyad.csv")

dyad_rep <- read_csv("../data/dyad_rep.csv") %>%
  filter(seed != 3) %>%
  mutate(thrown=ifelse(is.na(thrown)==T, 0,1))
 # filter(is.na(thrown)==T)

child_baseline <-read_csv("../data/child_baseline.csv") %>%
  filter(is.na(thrown)==T)
```

## Format Data for Display & Grid Analysis
```{r}
input_labs <- c("input_0_0", "input_0_1", "input_0_2", "input_0_3", "input_0_4", "input_0_5", "input_0_6", "input_0_7", "input_1_0", "input_1_1", "input_1_2", "input_1_3", "input_1_4", "input_1_5", "input_1_6", "input_1_7", "input_2_0", "input_2_1", "input_2_2", "input_2_3", "input_2_4", "input_2_5", "input_2_6", "input_2_7", "input_3_0", "input_3_1", "input_3_2", "input_3_3", "input_3_4", "input_3_5", "input_3_6", "input_3_7", "input_4_0", "input_4_1", "input_4_2", "input_4_3", "input_4_4", "input_4_5", "input_4_6", "input_4_7", "input_5_0", "input_5_1", "input_5_2", "input_5_3", "input_5_4", "input_5_5", "input_5_6", "input_5_7", "input_6_0", "input_6_1", "input_6_2", "input_6_3", "input_6_4", "input_6_5", "input_6_6", "input_6_7", "input_7_0", "input_7_1", "input_7_2", "input_7_3", "input_7_4", "input_7_5", "input_7_6", "input_7_7")
target_labs <- c("target_0_0", "target_0_1", "target_0_2", "target_0_3", "target_0_4", "target_0_5", "target_0_6", "target_0_7", "target_1_0", "target_1_1", "target_1_2", "target_1_3", "target_1_4", "target_1_5", "target_1_6", "target_1_7", "target_2_0", "target_2_1", "target_2_2", "target_2_3", "target_2_4", "target_2_5", "target_2_6", "target_2_7", "target_3_0", "target_3_1", "target_3_2", "target_3_3", "target_3_4", "target_3_5", "target_3_6", "target_3_7", "target_4_0", "target_4_1", "target_4_2", "target_4_3", "target_4_4", "target_4_5", "target_4_6", "target_4_7", "target_5_0", "target_5_1", "target_5_2", "target_5_3", "target_5_4", "target_5_5", "target_5_6", "target_5_7", "target_6_0", "target_6_1", "target_6_2", "target_6_3", "target_6_4", "target_6_5", "target_6_6", "target_6_7", "target_7_0", "target_7_1", "target_7_2", "target_7_3", "target_7_4", "target_7_5", "target_7_6", "target_7_7")
```

#Format Baseline Data
```{r format, include=F}
a_data <- adult_baseline %>% #puts each trial and either target or display in a separate row
  select(-(available_onload:available_accepted),  -sub_age) %>%
  gather(display, array, -(unique_id:time1Used), -(trial2Count:time2Used),
        -(trial4Count:time4Used), -(trial5Count:time5Used), -(trial6Count:time6Used),
        -(trial7Count:time7Used), -(trial8Count:time8Used), -(trial9Count:time9Used)) %>%
  unique() %>%
  separate(display, c("type", "trialCountArray"), -6) %>%
  separate(trialCountArray, c("trialCount", "arrayCount"), 1) %>%
  gather(trialDisplay, display, -(unique_id:time), -time1Used, -time2Used, -time4Used,                   -time5Used, -time6Used, -time7Used, -time8Used, -time9Used,  -type, -trialCount,
         -array) %>%
  separate(trialDisplay, c("type2", "tmp"), -7) %>%
  separate(type2, c("tmp2", "trialCount2"), -1) %>%
  filter(trialCount2 == trialCount) %>%
  gather(trialTime, timeUsed, -(unique_id:time), -type, -trialCount, -display, -array) %>%
  separate(trialTime, c("tmp", "trialCount3"), -5) %>%
  separate(trialCount3, c("trialCount3", "tmp2"), 1) %>%
  filter(trialCount == trialCount3) %>%
  select(unique_id:time, trialCount, trialDisplay = display, timeUsed, type, array) %>%
  spread(type, array) %>%
  separate(data, input_labs, sep = " ") %>%
  separate(target, target_labs, sep = " ") %>%
  mutate_at(c(input_labs, target_labs, "sub_id", "generation", "seed", "trialCount", "trialDisplay", "timeUsed"), as.numeric)

  a_calculate_data <-a_data %>%
  gather(row, value,-unique_id:-timeUsed)%>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(accuracy = input == target, sub_id = as.character(sub_id)) %>%
  arrange(seed, generation) 

a_spread_data <- a_data %>%
  gather(row, value, -(unique_id:timeUsed))%>%
  separate(row, c("type","row", "col")) %>%
  unite(ty_col, type, col) %>%
  spread(ty_col, value) %>%
  filter(is.na(row)==F)
```
#Format Data Replication
```{r}
a_data_rep <- adult_baseline_rep %>% #puts each trial and either target or display in a separate row
  select(-(available_onload:available_accepted),  -sub_age) %>%
  gather(display, array, -(unique_id:time1Used), -(trial2Count:time2Used), -(trial3Count:time3Used),
        -(trial4Count:time4Used), -(trial5Count:time5Used), -(trial6Count:time6Used),
        -(trial7Count:time7Used), -(trial8Count:time8Used), -(trial9Count:time9Used)) %>%
  unique() %>%
  separate(display, c("type", "trialCountArray"), -6) %>%
  separate(trialCountArray, c("trialCount", "arrayCount"), 1) %>%
  gather(trialDisplay, display, -(unique_id:time), -time1Used, -time2Used, -time3Used, -time4Used,                   -time5Used, -time6Used, -time7Used, -time8Used, -time9Used,  -type, -trialCount,
         -array) %>%
  separate(trialDisplay, c("type2", "tmp"), -7) %>%
  separate(type2, c("tmp2", "trialCount2"), -1) %>%
  filter(trialCount2 == trialCount) %>%
  gather(trialTime, timeUsed, -(unique_id:time), -type, -trialCount, -display, -array) %>%
  separate(trialTime, c("tmp", "trialCount3"), -5) %>%
  separate(trialCount3, c("trialCount3", "tmp2"), 1) %>%
  filter(trialCount == trialCount3) %>%
  select(unique_id:time, trialCount, trialDisplay = display, timeUsed, type, array) %>%
  spread(type, array) %>%
  separate(data, input_labs, sep = " ") %>%
  separate(target, target_labs, sep = " ") %>%
  mutate_at(c(input_labs, target_labs, "sub_id", "generation", "seed", "trialCount", "trialDisplay", "timeUsed"), as.numeric)

a_calculate_data_rep <-a_data_rep %>%
  gather(row, value,-unique_id:-timeUsed)%>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(accuracy = input == target, sub_id = as.character(sub_id)) %>%
  arrange(seed, generation) 

a_spread_data_rep <- a_data_rep %>%
  gather(row, value, -(unique_id:timeUsed))%>%
  separate(row, c("type","row", "col")) %>%
  unite(ty_col, type, col) %>%
  spread(ty_col, value) %>%
  filter(is.na(row)==F)
```
#Child Baseline 
```{r}
c_data <- child_baseline %>% #puts each trial and either target or display in a separate row
  select(-(available_onload:available_accepted),  -sub_age) %>%
  gather(display, array, -(unique_id:time1Used), -(trial2Count:time2Used), -(trial3Count:time3Used),
        -(trial4Count:time4Used), -(trial5Count:time5Used), -(trial6Count:time6Used),
        -(trial7Count:time7Used), -(trial8Count:time8Used), -(trial9Count:time9Used)) %>%
  unique() %>%
  separate(display, c("type", "trialCountArray"), -6) %>%
  separate(trialCountArray, c("trialCount", "arrayCount"), 1) %>%
  gather(trialDisplay, display, -(unique_id:time), -time1Used, -time2Used, -time3Used, -time4Used,                   -time5Used, -time6Used, -time7Used, -time8Used, -time9Used,  -type, -trialCount,
         -array) %>%
  separate(trialDisplay, c("type2", "tmp"), -7) %>%
  separate(type2, c("tmp2", "trialCount2"), -1) %>%
  filter(trialCount2 == trialCount) %>%
  gather(trialTime, timeUsed, -(unique_id:time), -type, -trialCount, -display, -array) %>%
  separate(trialTime, c("tmp", "trialCount3"), -5) %>%
  separate(trialCount3, c("trialCount3", "tmp2"), 1) %>%
  filter(trialCount == trialCount3) %>%
  select(unique_id:time, trialCount, trialDisplay = display, timeUsed, type, array) %>%
  spread(type, array) %>%
  separate(data, input_labs, sep = " ") %>%
  separate(target, target_labs, sep = " ") %>%
  mutate_at(c(input_labs, target_labs, "sub_id", "generation", "seed", "trialCount", "trialDisplay", "timeUsed"), as.numeric)

c_calculate_data <-c_data %>%
  gather(row, value,-unique_id:-timeUsed)%>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(accuracy = input == target, sub_id = as.character(sub_id)) %>%
  arrange(seed, generation) 

c_spread_data <- c_data %>%
  gather(row, value, -(unique_id:timeUsed))%>%
  separate(row, c("type","row", "col")) %>%
  unite(ty_col, type, col) %>%
  spread(ty_col, value) %>%
  filter(is.na(row)==F)
```

#Format Dyad Data 
```{r}
t_data <- turk_dyad %>%
  select(-(available_onload:available_accepted), -sub_age) %>%
  gather(display, array, -(unique_id:time1Used), -(trial2Count:time2Used),                              -(trial3Count:time3Used),-(trial4Count:time4Used), -(trial5Count:time5Used),                     -(trial6Count:time6Used),-(trial7Count:time7Used), -(trial8Count:time8Used),                     -(trial9Count:time9Used)) %>%
  unique() %>%
  separate(display, c("type", "trialCountArray"), -6) %>%
  separate(trialCountArray, c("trialCount", "arrayCount"), 1) %>%
  gather(trialDisplay, display, -(unique_id:time), -time1Used, -time2Used, -time3Used,-time4Used,       -time5Used, -time6Used, -time7Used, -time8Used, -time9Used,  -type,-trialCount, -array) %>%
  separate(trialDisplay, c("type2", "tmp"), -7) %>%
  separate(type2, c("tmp2", "trialCount2"), -1) %>%
  filter(trialCount2 == trialCount) %>%
  gather(trialTime, timeUsed, -(unique_id:time), -type, -trialCount, -display, -array) %>%
  separate(trialTime, c("tmp", "trialCount3"), -5) %>%
  separate(trialCount3, c("trialCount3", "tmp2"), 1) %>%
  filter(trialCount == trialCount3) %>%
  select(unique_id:time, trialCount, trialDisplay = display, timeUsed, type, array) %>%
  spread(type, array) %>%
  separate(data, input_labs, sep = " ") %>%
  separate(target, target_labs, sep = " ") %>%
  mutate_at(c(input_labs, target_labs, "sub_id", "generation", "seed", "trialCount", "trialDisplay", "timeUsed"), as.numeric) %>%
  mutate(generation = ifelse(condition == "child", generation-0.5, generation))

t_calculate_data <-t_data %>%
  gather(row, value,-unique_id:-timeUsed)%>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(accuracy = input == target, sub_id = as.character(sub_id),
         trialDisplay = ifelse(trialCount == 3, 0.75, trialDisplay)) %>%
  arrange(seed, generation) 

t_spread_data <- t_data %>%
  gather(row, value, -(unique_id:timeUsed))%>%
  separate(row, c("type","row", "col")) %>%
  unite(ty_col, type, col) %>%
  spread(ty_col, value) %>%
  filter(is.na(row)==F) %>%
  mutate(trialDisplay = ifelse(trialCount == 3, 0.75, trialDisplay))
```

#Format data dyad rep
```{r}
t_data_rep <- dyad_rep%>%
  select(-(available_onload:available_accepted), -sub_age) %>%
  gather(display, array, -(unique_id:time1Used), -(trial2Count:time2Used),                              -(trial3Count:time3Used),-(trial4Count:time4Used), -(trial5Count:time5Used),                     -(trial6Count:time6Used),-(trial7Count:time7Used), -(trial8Count:time8Used),                     -(trial9Count:time9Used)) %>%
  unique() %>%
  separate(display, c("type", "trialCountArray"), -6) %>%
  separate(trialCountArray, c("trialCount", "arrayCount"), 1) %>%
  gather(trialDisplay, display, -(unique_id:time), -time1Used, -time2Used, -time3Used,-time4Used,       -time5Used, -time6Used, -time7Used, -time8Used, -time9Used,  -type,-trialCount, -array) %>%
  separate(trialDisplay, c("type2", "tmp"), -7) %>%
  separate(type2, c("tmp2", "trialCount2"), -1) %>%
  filter(trialCount2 == trialCount) %>%
  gather(trialTime, timeUsed, -(unique_id:time), -type, -trialCount, -display, -array) %>%
  separate(trialTime, c("tmp", "trialCount3"), -5) %>%
  separate(trialCount3, c("trialCount3", "tmp2"), 1) %>%
  filter(trialCount == trialCount3) %>%
  select(unique_id:time, trialCount, trialDisplay = display, timeUsed, type, array) %>%
  spread(type, array) %>%
  separate(data, input_labs, sep = " ") %>%
  separate(target, target_labs, sep = " ") %>%
  mutate_at(c(input_labs, target_labs, "sub_id", "generation", "seed", "trialCount", "trialDisplay", "timeUsed"), as.numeric) %>%
  mutate(generation = ifelse(condition == "child", generation-0.5, generation))

t_calculate_data_rep <-t_data_rep %>%
  gather(row, value,-unique_id:-timeUsed)%>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(accuracy = input == target, sub_id = as.character(sub_id),
         trialDisplay = ifelse(trialCount == 3, 0.75, trialDisplay)) %>%
  arrange(seed, generation) 

t_spread_data_rep <- t_data_rep %>%
  gather(row, value, -(unique_id:timeUsed))%>%
  separate(row, c("type","row", "col")) %>%
  unite(ty_col, type, col) %>%
  spread(ty_col, value) %>%
  filter(is.na(row)==F) %>%
  mutate(trialDisplay = ifelse(trialCount == 3, 0.75, trialDisplay))
```

#Calculate Complexity Measures
Includes calculations for Algorithmic Complexity (BDM), Edge Length, Chunking, and Earth-Mover Distance
```{r format_data_complexity}
a_bdm_data <- a_spread_data %>%
  filter(trialDisplay >=1, generation != 0) %>%
  select(sub_id, generation,trialDisplay, row, input_0:input_7) %>%
  arrange(sub_id,trialDisplay, row)

a_target_data <- a_spread_data %>%
  filter(trialDisplay >=1 & generation == 0)  %>%
  select(sub_id, generation,trialDisplay, row, target_0 = input_0, target_1 = input_1, target_2 =input_2, target_3 = input_3, target_4 = input_4, target_5 = input_5, target_6 = input_6, target_7 =input_7) %>%
  mutate(sub_id = 0) %>%
  arrange(trialDisplay,row) %>%
  unique()
 
a_target_store <- data.frame(bdm = bdm_function(a_target_data),
                           chunking = nPart_function(a_target_data),
                           edge = edge_function(a_target_data)) 
a_bdm_store <- data.frame(bdm = bdm_function(a_bdm_data),
                        chunking = nPart_function(a_bdm_data),
                        edge = edge_function(a_bdm_data))

a_emds <- a_spread_data %>%
  arrange(sub_id) %>%
  filter(trialCount > 3) %>%
  mutate(sub_id = ifelse(generation ==0, 0, sub_id)) %>%
  split(paste0(.$sub_id, .$trialDisplay, sep="_")) %>%
  map(emd_helper) %>%
  bind_rows() %>%
  arrange(sub_id) %>%
  select(emd) %>%
  mutate(emd = ifelse(emd == "NaN", 0, emd))

a_bind_targets <- a_target_data %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(a_target_store, .)

a_bind_data <- a_bdm_data %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(a_bdm_store, .) %>%
  bind_rows(. , a_bind_targets) %>%
  mutate_all(as.numeric) %>%
  group_by(sub_id,trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) %>%
  bind_cols(.,a_emds)
```
#Kiddos
```{r}
c_bdm_data <- c_spread_data %>%
  filter(trialDisplay >=1, generation != 0) %>%
  select(sub_id, generation,trialDisplay, row, input_0:input_7) %>%
  arrange(sub_id,trialDisplay, row)

c_target_data <- c_spread_data %>%
  filter(trialDisplay >=1 & generation == 0)  %>%
  select(sub_id, generation,trialDisplay, row, target_0 = input_0, target_1 = input_1, target_2 =input_2, target_3 = input_3, target_4 = input_4, target_5 = input_5, target_6 = input_6, target_7 =input_7) %>%
  mutate(sub_id = 0) %>%
  arrange(trialDisplay,row) %>%
  unique()
 
c_target_store <- data.frame(bdm = bdm_function(c_target_data),
                           chunking = nPart_function(c_target_data),
                           edge = edge_function(c_target_data)) 
c_bdm_store <- data.frame(bdm = bdm_function(c_bdm_data),
                        chunking = nPart_function(c_bdm_data),
                        edge = edge_function(c_bdm_data))

c_emds <- c_spread_data %>%
  filter(trialDisplay >=1)  %>%
  arrange(sub_id) %>%
  filter(trialCount > 3) %>%
  mutate(sub_id = ifelse(generation ==0, 0, sub_id)) %>%
  split(paste0(.$sub_id, .$trialDisplay, sep="_")) %>%
  map(emd_helper) %>%
  bind_rows() %>%
  arrange(sub_id) %>%
  select(emd) %>%
  mutate(emd = ifelse(emd == "NaN", 0, emd))

c_bind_targets <- c_target_data %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(c_target_store, .)

c_bind_data <- c_bdm_data %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(c_bdm_store, .) %>%
  bind_rows(. , c_bind_targets) %>%
  mutate_all(as.numeric) %>%
  group_by(sub_id,trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) %>%
  bind_cols(.,c_emds)
```

#Replication
```{r}
a_bdm_data_rep <- a_spread_data_rep %>%
  filter(trialDisplay >=1, generation != 0) %>%
  select(sub_id, generation,trialDisplay, row, input_0:input_7) %>%
  arrange(sub_id,trialDisplay, row)

a_target_data_rep <- a_spread_data_rep %>%
  filter(trialDisplay >=1 & generation == 0)  %>%
  select(sub_id, generation,trialDisplay, row, target_0 = input_0, target_1 = input_1, target_2 =input_2, target_3 = input_3, target_4 = input_4, target_5 = input_5, target_6 = input_6, target_7 =input_7) %>%
  mutate(sub_id = 0) %>%
  arrange(trialDisplay,row) %>%
  unique()
 
a_target_store_rep <- data.frame(bdm = bdm_function(a_target_data_rep),
                           chunking = nPart_function(a_target_data_rep),
                           edge = edge_function(a_target_data_rep)) 
a_bdm_store_rep <- data.frame(bdm = bdm_function(a_bdm_data_rep),
                        chunking = nPart_function(a_bdm_data_rep),
                        edge = edge_function(a_bdm_data_rep))

a_emds_rep <- a_spread_data_rep %>%
  arrange(sub_id) %>%
  filter(trialCount > 3) %>%
  mutate(sub_id = ifelse(generation ==0, 0, sub_id)) %>%
  split(paste0(.$sub_id, .$trialDisplay, sep="_")) %>%
  map(emd_helper) %>%
  bind_rows() %>%
  arrange(sub_id) %>%
  select(emd) %>%
  mutate(emd = ifelse(emd == "NaN", 0, emd))

a_bind_targets_rep <- a_target_data_rep %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(a_target_store_rep, .)

a_bind_data_rep <- a_bdm_data_rep %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(a_bdm_store_rep, .) %>%
  bind_rows(. , a_bind_targets_rep) %>%
  mutate_all(as.numeric) %>%
  group_by(sub_id,trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) %>%
  bind_cols(.,a_emds_rep)
```

#Dyad condition
```{r format_data_complexity2}
t_bdm_data <- t_spread_data %>%
  filter(trialDisplay >=1, generation != 0) %>%
  select(sub_id, generation,trialDisplay, row, input_0:input_7) %>%
  arrange(sub_id,trialDisplay, row)

t_target_data <- t_spread_data %>%
  filter(trialDisplay >=1 & generation == 0)  %>%
  select(sub_id, generation,trialDisplay, row, target_0 = input_0, target_1 = input_1, target_2 =input_2, target_3 = input_3, target_4 = input_4, target_5 = input_5, target_6 = input_6, target_7 =input_7) %>%
  mutate(sub_id = 0) %>%
  arrange(trialDisplay,row) %>%
  unique()
 
t_target_store <- data.frame(bdm = bdm_function(t_target_data),
                           chunking = nPart_function(t_target_data),
                           edge = edge_function(t_target_data)) 
t_bdm_store <- data.frame(bdm = bdm_function(t_bdm_data),
                        chunking = nPart_function(t_bdm_data),
                        edge = edge_function(t_bdm_data))

t_emds <- t_spread_data %>%
  arrange(sub_id) %>%
  filter(trialDisplay >=1) %>%
  mutate(sub_id = ifelse(generation ==0, 0, sub_id)) %>%
  split(paste0(.$sub_id, .$trialDisplay, sep="_")) %>%
  map(emd_helper) %>%
  bind_rows() %>%
  select(emd) %>%
  mutate(emd = ifelse(emd == "NaN", 0, emd))

t_bind_targets <- t_target_data %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(t_target_store, .)

t_bind_data <- t_bdm_data %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(t_bdm_store, .) %>%
  bind_rows(. , t_bind_targets) %>%
  mutate_all(as.numeric) %>%
  group_by(sub_id,trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) %>%
  bind_cols(.,t_emds) %>%
  ungroup() %>%
  arrange(generation)
```

#Replication
```{r}
t_bdm_data_rep <- t_spread_data_rep %>%
  filter(trialDisplay >=1, generation != 0) %>%
  select(sub_id, generation,trialDisplay, row, input_0:input_7) %>%
  arrange(sub_id,trialDisplay, row)

t_target_data_rep <- t_spread_data_rep %>%
  filter(trialDisplay >=1 & generation == 0)  %>%
  select(sub_id, generation,trialDisplay, row, target_0 = input_0, target_1 = input_1, target_2 =input_2, target_3 = input_3, target_4 = input_4, target_5 = input_5, target_6 = input_6, target_7 =input_7) %>%
  mutate(sub_id = 0) %>%
  arrange(trialDisplay,row) %>%
  unique()
 
t_target_store_rep <- data.frame(bdm = bdm_function(t_target_data_rep),
                           chunking = nPart_function(t_target_data_rep),
                           edge = edge_function(t_target_data_rep)) 
t_bdm_store_rep <- data.frame(bdm = bdm_function(t_bdm_data_rep),
                        chunking = nPart_function(t_bdm_data_rep),
                        edge = edge_function(t_bdm_data_rep))

t_emds_rep <- t_spread_data_rep %>%
  arrange(sub_id) %>%
  filter(trialDisplay >=1) %>%
  mutate(sub_id = ifelse(generation ==0, 0, sub_id)) %>%
  split(paste0(.$sub_id, .$trialDisplay, sep="_")) %>%
  map(emd_helper) %>%
  bind_rows() %>%
  select(emd) %>%
  mutate(emd = ifelse(emd == "NaN", 0, emd))

t_bind_targets_rep <- t_target_data_rep %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(t_target_store_rep, .)

t_bind_data_rep <- t_bdm_data_rep %>%
  group_by(sub_id,trialDisplay, generation) %>%
  summarise(.) %>%
  bind_cols(t_bdm_store_rep, .) %>%
  bind_rows(. , t_bind_targets_rep) %>%
  mutate_all(as.numeric) %>%
  group_by(sub_id,trialDisplay, generation)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) %>%
  bind_cols(.,t_emds_rep) %>%
  ungroup() %>%
  arrange(generation)
```

#All Data 
```{r}
all_data <- a_data %>%
  mutate(type = "baseline", condition = "adult") %>%
  bind_rows(mutate(t_data, type="dyad"))%>%
  bind_rows(mutate(a_data_rep, type = "baseline_rep", condition = "adult")) %>%
  bind_rows(mutate(t_data_rep, type = "dyad_rep"))%>%
  bind_rows(mutate(c_data, type = "baseline", condition = "child"))

all_calculate_data <- a_calculate_data %>%
  mutate(type = "baseline", condition = "adult") %>%
  bind_rows(mutate(t_calculate_data, type="dyad"))%>%
  bind_rows(mutate(a_calculate_data_rep, type = "baseline_rep", condition = "adult"))%>%
  bind_rows(mutate(t_calculate_data_rep, type = "dyad_rep"))%>%
  bind_rows(mutate(c_calculate_data, type = "baseline", condition = "child")) 

all_spread_data <- a_spread_data %>%
  mutate(type = "baseline", condition = "adult") %>%
  bind_rows(mutate(t_spread_data, type="dyad")) %>%
  bind_rows(mutate(a_spread_data_rep, type="baseline_rep", condition = "adult"))%>%
  bind_rows(mutate(t_spread_data_rep, type = "dyad_rep"))%>%
  bind_rows(mutate(c_spread_data, type = "baseline", condition = "child"))

all_bind_data <- a_bind_data %>%
  mutate(type = "baseline") %>%
  bind_rows(mutate(t_bind_data, type="dyad")) %>%
  bind_rows(mutate(a_bind_data_rep, type="baseline_rep")) %>%
  bind_rows(mutate(t_bind_data_rep, type = "dyad_rep")) %>%
  mutate(condition = if_else(floor(generation) != generation, "child", "adult"))%>%
  bind_rows(mutate(c_bind_data, type = "baseline", condition = "child")) 
```

```{r curve fitting}

linear <- lmer(bdm_mean ~ generation + (1|sub_id) + (1|trialDisplay),
                filter(all_bind_data, type == "dyad", condition == "adult"))

exponential <- lmer(log(bdm_mean) ~ log(generation+1) + (1|sub_id) + (1|trialDisplay),
                filter(all_bind_data, type == "dyad", condition == "adult"))

log <- lmer(bdm_mean ~ log(generation+1) + (1|sub_id) + (1|trialDisplay),
                filter(all_bind_data, type == "dyad", condition == "adult"))



mean_data <- all_bind_data %>%
  filter(type == "dyad", condition == "adult") %>%
  group_by(generation, sub_id) %>%
  summarise(bdm_mean = mean(bdm_mean)) 

linear <- lmer(bdm_mean ~ generation + (1|sub_id) + (1|trialDisplay),
               data = filter(all_bind_data, type == "dyad", condition == "adult", 
                             generation >0 ))

exp <- lmer(scale(log(bdm_mean)) ~ scale(log(generation)) + (1|sub_id) + (1|trialDisplay),
               data = filter(all_bind_data, type == "dyad", condition == "adult",
                             generation > 0))

log <- lmer(bdm_mean ~ log(generation) + (1|sub_id) + (1|trialDisplay),
               data = filter(all_bind_data, type == "dyad", condition == "adult",
                             generation > 0))
        
power.f = deriv(~k+a*generation^b, namevec=c('k','a','b'), function.arg=c('generation', 'k', 'a', 'b'))


ranef(fit.nlmer) %>% 
  as.data.frame() %>% 
  as_data_frame() %>%
  rename(sub_id = grp) %>%
  mutate(sub_id = as.numeric(as.character(sub_id))) %>%
  select(sub_id, condval) %>%
  left_join(select(all_bind_data, sub_id, generation)) %>%
  group_by(generation) %>%
  summarise(mean = mean(condval), sd = sd(condval))

fit.nlmer<- nlmer(bdm_mean ~ power.f(generation,k,a,b) ~ k|sub_id, start= list(nlpars=c(k=106,a=123,b=-.1)), control = nlmerControl(optCtrl = list(maxfun=20000)),
               data = filter(all_bind_data, condition == "adult", type == "dyad", generation >0 ))


predictions <- all_bind_data %>%
  filter(condition == "adult", type == "dyad", generation >0) %>%
  ungroup() %>%
  mutate(prediction = predict(fit.nlmer, re.form = NULL)) %>%
  gather(source, value, bdm_mean, prediction) %>%
  group_by(source, generation, sub_id) %>%
  summarise(mean = mean(value)) %>%
  tidyboot_mean(mean)

ggplot(predictions, aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                        ymax = ci_upper, color = source)) + 
  geom_pointrange() +
  geom_smooth(se = F)
  

power_f <- function(x, k, a, b) {
  k + a * x ^b
}


mean_data %>%
  ungroup() %>%
  mutate(linear = predict(linear),
         log = predict(log),
         exp = exp(predict(exp))) %>%
  gather(method, prediction, linear, log, exp) %>%
  ggplot(aes(x = generation)) +
  geom_line(aes(y = prediction, color = method)) +
  geom_jitter(width = .1, aes(y = bdm_mean), data = mean_data) 

  geom_smooth(method = "lm", color = "red") +
  geom_smooth(method = "lm", formula = " y ~ log(x+1)", color = "blue") +
  geom_smooth(method = "lm", formula = " log(y) ~ log(x+1)", color = "green")
```

#Outlier Check
Even though our outliers were tested for as the study was running, this graphs percent accuracy for practice and training trials to make sure everything worked as expected.
```{r, eval = F, include = F}
thrown <- read.csv("../data/thrown_turk_dyad.csv") 
not_thrown <- thrown %>%
  filter(THROWN != 1)
thrown <- thrown %>%
  filter(THROWN == 1, seed != 1, timedOut != 1, !(unique_id %in% not_thrown$unique_id) )
```

```{r outlier_check, eval = F, include = F}
subject_accuracy <- thrown_calculate_data %>%
  filter(target == 1, trialDisplay != 0) %>% #for dyad task, calculated accuracy on second 2 training trials, not first one
  mutate(type = factor(trialDisplay<1, labels = c("test", "practice"))) %>%
  group_by(type, generation, unique_id, trialDisplay) %>%
  summarise(accuracy = mean(accuracy)) %>%
  mutate(condition = if_else(floor(generation) != generation, "child", "adult"))


subject_accuracy %>%
  summarise(accuracy = mean(accuracy)) %>%
  ggplot(aes(x = accuracy)) + 
  facet_grid(generation~type) + 
  geom_histogram()

not_thrown <- subject_accuracy %>%
  summarise(accuracy = mean(accuracy)) %>%
  filter(accuracy > 0.75) 

generation_accuracy <- subject_accuracy %>%
  summarise(accuracy = mean(accuracy)) %>%
  summarise(mean = mean(accuracy), 
            lower_bound = mean - 2.5 * sd(accuracy),
            upper_bound = mean + 2.5 * sd(accuracy))

subject_accuracy %>%
  filter(type == "practice", trialDisplay != 0) %>%
  filter(accuracy < 0.75) %>%
  View()
```

```{r}
a14_data2 <-all_calculate_data %>%
  filter(type == "baseline_rep" & condition == "adult" & trialDisplay == 5 & seed==14)
```

## Descriptive
Displays the actual grids that people made; printed them and saved (have to do for each individual seed separately)
```{r, eval=F, include=F}
a14_data <- all_calculate_data %>%
  filter(type == "baseline_rep" & condition=="adult", seed == 14) %>%
  mutate(fill = ifelse((input ==1 & target ==1), 1, ifelse(target ==1, 0.5, ifelse(input ==1, 0.75, ifelse(target != 0, input, 0)))),
         filltype = ifelse(accuracy == T, "both", ifelse(input == 1, "input", "target"))) %>%
  mutate(fill = ifelse(is.na(fill)==T, input, fill)) %>%
  arrange(generation)
```

```{r plot_grids, eval = F, include=F}
pdf("a14.pdf", width = 10, height = 10)
a14_data %>%
  bind_rows(select(a14_data, generation, trialDisplay, row, col, input)) %>%
  mutate(input = factor(input), 
         generation = factor(generation, levels = unique(.$generation))) %>%
  mutate(row = 7 - as.numeric(row)) %>%
  ggplot(aes(x = col, y = row, fill = factor(fill))) +
  facet_grid(trialDisplay ~ generation) +
  geom_tile(color = "black") +
  scale_fill_manual(values = c("0" = "white", "1" = "blue", "0.5" = "white", "0.75"="blue"), labels = c("none", "original", "new", "unchanged")) +
  guides(fill=guide_legend(title="changed"))
dev.off()

```

## Time Used per trial
How much time did people use on each trial? did this go down over generations?
```{r time_used}
time_used <- all_data %>%
  filter(generation != 0, is.na(timeUsed)==F)
```

There doesn't seem to be a relationship between the amount of time used and generation number. This is contrary to a proposed hypothesis that people would use less time per trial as generation increases. 
```{r time_gen}
time_used %>%  
  group_by(type, condition, generation) %>%
  mutate(totalTime = sum(timeUsed)/n()) %>%
  ggplot(aes(x=generation, y=totalTime, color=interaction(condition,type))) + 
  geom_point() + 
  facet_grid(type~condition, scales = "free")+
  geom_smooth(span = 1, method = "loess")
```

People don't seem to vary on the amount of time used and which display they were shown, except that they used less time for the training trials (presumably because the trainings were easier). People also seem to use slightly less time per trial as the experiment goes on (because they start to get less engaged?). However, % accuracy did not seem to decrease much as the study went on.
```{r time_trial}
time_used %>%
  group_by(trialDisplay, type, condition) %>%
  mutate(totalTime = sum(timeUsed)/n()) %>%
  ggplot(aes(x=trialDisplay, y=totalTime, color=condition)) +
  geom_point() +
  scale_x_continuous(breaks =c(0, 0.5, 0.75, 1, 2, 3, 4, 5, 6)) +
  facet_wrap(~type) +
  geom_line(aes(group=condition))

time_used %>%
  group_by(trialCount, type, condition) %>%
  mutate(totalTime = sum(timeUsed)/n()) %>%
  ggplot(aes(x=trialCount, y=totalTime, color=condition)) +
  geom_point() +
  scale_x_continuous(breaks =c(1, 2, 3, 4, 5, 6, 7, 8, 9)) +
  facet_wrap(~type) +
  geom_smooth(method = "loess", se = F, aes(group=condition))
```


## Percent Accuracy 
This is one of the methods we can look at to judge the grids that people produced. We expect to see increases in % accuracy across generations because this measure approximates transmission accuracy. 

Percent accuracies calculated by %/10 stickers placed correctly between target and input 
```{r accuracy}
trial_data <- all_calculate_data %>%
 filter(generation != 0) %>% #takes out initial generations 
  filter(target == 1) #calculate out of 10 stickers placed correctly, not 64
```

We don't see any practice effects within individuals. 
```{r trial_order}
trial_data %>%
  group_by(trialCount, sub_id) %>%
  summarise(accuracy=mean(accuracy)) %>%
  tidyboot_mean(accuracy) %>%
  ggplot(aes(x = trialCount, y = empirical_stat, ymin = ci_lower, ymax = ci_upper)) + 
  geom_pointrange()+
  ylab("average percent accuracy") +
  scale_x_continuous(breaks=c(1,2,3,4,5,6,7,8,9))
```

% accuracy by trial display. People found trial 6 to be easier than the other trials overall. 
```{r trial_display}
trial_data %>%
  group_by(trialDisplay, type, condition) %>%
  summarise(accuracy=mean(accuracy)) %>%
  group_by(trialDisplay, type, condition) %>%
  tidyboot_mean(accuracy) %>%
  ggplot(aes(x = trialDisplay, y = empirical_stat, ymin = ci_lower, ymax = ci_upper, color=condition)) +
  geom_pointrange()+
  geom_line(aes(group=condition)) +
  ylab("average percent accuracy") +
  scale_x_continuous(breaks=c(0,0.5,0.75,1,2,3,4,5,6)) +
  facet_wrap(~type)
```

Percent accuracy over generations. It increases over gens 1-4 and then seems to level off(?). This is similar to what we would expect but interesting in context with the consistent complexity findings below. 
```{r}
acc_data <- trial_data %>%
 # filter(generation < 7) %>%
 # filter(type == "child_baseline") %>%
  filter( type != "baseline" & type != "dyad" & type == "dyad_rep" ) %>%
  mutate(type =  ifelse(type == "baseline_rep", "baseline", ifelse((condition == "child" & type=="baseline"), "child_baseline", ifelse(condition == "adult", "fixer","learner")))) %>%
  filter(trialCount > 3) %>%
  mutate(generation = ifelse(condition == "dyad.learner", generation+0.5, generation)) %>%
  group_by(generation, sub_id, type, condition) %>%
  summarise(accuracy = mean(accuracy)) %>%
  group_by(generation,type, condition) %>%
  tidyboot_mean(accuracy) 

jpeg("gen_ac2c.jpeg", width = 6, height = 4, units = "in", res = 600)
ggplot(acc_data, aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                     ymax = ci_upper, color = type, label = type)) +
  geom_pointrange(position = position_dodge(.25))+
  #geom_smooth( span = 0.9, se = F, aes(group=type))+
     geom_smooth( method = "lm", se = F, aes(group=type))+
  # geom_smooth( method = "lm", se = F, aes(group=type), position = position_dodge(.25))+
  ylab("accuracy") +
  scale_x_continuous(breaks=seq(0,12), limits = c(0, 15)) +
  theme_classic(base_size = 20) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  geom_dl(method = list(dl.trans(x = x + .2), "last.points", cex = 1.5)) +
  scale_color_brewer(palette = "Dark2")
dev.off()

```

```{r}
acc_data <- trial_data %>%
 # filter(generation < 7) %>%
 # filter(type == "child_baseline") %>%
  filter( type != "baseline" & type != "dyad" & type != "child_baseline" & type != "dyad_rep") %>%
  mutate(type =  ifelse(type == "baseline_rep", "baseline", ifelse((condition == "child" & type=="baseline"), "child_baseline", ifelse(condition == "child", "learner dyad","fixer dyad")))) %>%
  filter(trialCount > 3) %>%
  mutate(generation = ifelse(condition == "dyad.learner", generation+0.5, generation)) %>%
  group_by(generation, sub_id, type, condition) %>%
  summarise(accuracy = mean(accuracy)) %>%
  group_by(generation,type, condition) %>%
  tidyboot_mean(accuracy) 

jpeg("gen_acc.jpeg", width = 6, height = 4, units = "in", res = 600)
ggplot(acc_data, aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                     ymax = ci_upper, color = type, label = type)) +
  geom_pointrange(position = position_dodge(.25))+
  #geom_smooth( span = 0.9, se = F, aes(group=type))+
     geom_smooth( method = "lm", se = F, aes(group=type))+
  # geom_smooth( method = "lm", se = F, aes(group=type), position = position_dodge(.25))+
  ylab("accuracy") +
  scale_x_continuous(breaks=seq(0,12), limits = c(0, 15)) +
  theme_classic(base_size = 20) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  geom_dl(method = list(dl.trans(x = x + .2), "last.points", cex = 1.5)) +
  scale_color_brewer(palette = "Set1")
dev.off()


acc_mer_data <- trial_data %>%
  filter( type != "baseline") %>%
  mutate(type = ifelse(type == "baseline_rep", "learner baseline", ifelse(condition == "child", "learner dyad","fixer dyad"))) %>%
  filter(trialCount > 3) %>%
  mutate(generation = ifelse(condition == "dyad.learner", generation+0.5, generation)) 

lmer(accuracy ~ generation + (1|seed) + (1|sub_id),
               filter(acc_mer_data, type == "learner baseline")) %>%
  summary()

```

Percent accuracy over generation by seed to see variations between seeds, though they seem to show similar (ish) trends
```{r}
#seeds are diverse but generally constant 
trial_data %>%
    mutate(type =  ifelse(type == "baseline_rep", "learner baseline", ifelse((condition == "child" & type=="baseline"), "child_baseline", ifelse(condition == "child", "learner dyad","fixer dyad")))) %>%
  group_by(type,seed, sub_id) %>%
  summarise(accuracy=mean(accuracy)) %>%
  tidyboot_mean(accuracy)%>%
  ggplot(aes(x = seed, y = empirical_stat, ymin = ci_lower, ymax = ci_upper, color=type)) + 
  geom_pointrange() +
  geom_smooth(method = "lm", se=F)+
  ylab("average percent accuracy")
```

Percent accuracy x timeUsed
```{r}
 trial_data2 <- trial_data %>%
  group_by(type, condition, generation, unique_id) %>%
  summarise(accuracy = mean(accuracy), avgTime =mean(timeUsed)) %>%
  mutate_at(vars(accuracy, avgTime), scale) %>%
  ungroup() %>%
  unite(group, type, condition) 


trial_data2 %>%
  ggplot(aes(x = accuracy,  y=avgTime, color = group)) +
  facet_wrap(~group) +
  geom_point()


lmer(accuracy ~ avgTime * group + generation + (1|unique_id), data =  trial_data2) %>%
  summary()

ggplot(trial_data2, aes(x=accuracy, y=avgTime, color = interaction(type,condition)))+
  #facet_grid(condition~type)+
  geom_point()+
  geom_smooth(se=F, method = "lm")
```

## Analyses of Complexity
There are many different methods of analyzing the "simplicity" or "complexity" of these grids. None of them are perfect, but taken together they present a unfied picture of what is happening over generations.

##BDM
The Block Decomposition Method for Algorithmic Complexity splits the grids into overlapping 4x4 units, and calculates the Kolmogorov-Chaitin Complexity (based on coding theorem method) for each 4x4 grid. This method compares the power used to produce a particular pattern by a turing machine. We have reason to believe that this is the best measure of general complexity that we have for the grids. 

## Chunking
Chunking is defined as the number of discrete parts of the grid. A chunk consists of any targets which are connected by an edge. This does not include elements which are diagonal to each other.

## Edge Length
Edge length can be defined as a measure of how "crooked" a grid pattern is. It essentially counts the length of the edges of the targets seen. Targets which are connected have a lower edge length. A checkerboard pattern would result in the largest edge length. 

##Results
Algorithmic complexity decreases linearly by generation. Kempe found a 30pt decrease in first 6 generations which is approximately the same seen here. When you divide by trial display you see a consistent trend with some variation.
```{r}
complex<-all_bind_data%>%
  filter( type == "baseline_rep" | (type=="baseline" & condition=="child"), generation < 7  ) %>%
  group_by(generation, type) %>%
  tidyboot_mean(bdm_mean) %>%
  mutate(condition = if_else(type == "baseline_rep", "adult", "child"))
 # mutate(condition = if_else(floor(generation) != generation, 
             #                "learner", ifelse(type =="child_baseline",
                #                               "child","fixer"))) %>%
#  mutate(type = ifelse(type == "baseline_rep", "baseline", 
                     #  ifelse(type=="child_baseline", "child_baseline", 
                         #     ifelse(condition == "child", "learner", "fixer")))) %>%
#  mutate(condition = factor(condition, levels = c("learner", "fixer", "initial")))

jpeg("kid_complex.jpeg", width = 6, height = 4, units = "in", res = 600)
ggplot(complex, aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                     ymax = ci_upper, color = condition, label = condition)) +
 # geom_line(color="black")+
  geom_pointrange(position = position_dodge(.25))+
geom_smooth( span = 1.3, se = F, aes(group=type))+

  #  geom_smooth( method = "lm", se = F, aes(group=type))+
  # geom_smooth( method = "lm", se = F, aes(group=type), position = position_dodge(.25))+
  ylab("complexity") +
  #scale_x_continuous(breaks=seq(0,12), limits = c(0, 15)) +
  scale_x_continuous(breaks=seq(0,6), limits = c(0, 8)) +
 # scale_y_continuous( limits = c(205, 240)) +
  theme_classic(base_size = 20) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  geom_dl(method = list(dl.trans(x = x + .2), "last.points", cex = 1.5)) +
  scale_color_manual(values=c("forestgreen","blue"))
  # scale_color_brewer(palette = "Set1")
dev.off()
```

```{r complexity_graphs}
t_bind_data %>%
  mutate(condition = if_else(floor(generation) != generation, "child", "adult")) %>%
  group_by(generation, condition) %>% 
  tidyboot_mean(bdm_mean) %>%
  ggplot(aes(x = generation, y = empirical_stat, ymin = ci_lower, ymax = ci_upper, color = condition)) +
  geom_pointrange() + 
  ylab("algorithmic complexity") + 
  ggtitle("algorithmic complexity over generations")

all_bind_data  %>%
  filter(generation<7) %>%
 # filter(type != "baseline" & type != "dyad") %>%
  group_by(generation, type) %>%
  tidyboot_mean(bdm_mean) %>%
  mutate(condition = if_else(floor(generation) != generation, "child", ifelse(type =="child_baseline", "child","adult"))) %>%
  mutate(type = ifelse(type == "baseline_rep", "learner baseline", ifelse(type=="child_baseline", "child_baseline", ifelse(condition == "child", "learner dyad", "fixer dyad")))) %>%
  ggplot(aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                      ymax = ci_upper, color = type, group=type)) + 
  geom_pointrange() + 
  geom_smooth(span = 0.9,method = "loess", se = F)+
  ylab("algorithmic complexity") + 
  ggtitle("Algorithmic Complexity over Generations") +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12)) +
  theme(plot.title = element_text(hjust = 0.5))

c_plot_data <- c_bind_data %>%
  group_by(sub_id, generation) %>%
  tidyboot_mean(bdm_mean)

#ADD SEED INFO
ggplot(c_plot_data, aes(x=generation, y=empirical_stat, ymin=ci_lower, ymax=ci_upper) +
  geom_pointrange() +
  geom_line()


individual_data <- all_bind_data %>%
    mutate(condition = if_else(floor(generation) != generation, "child", "adult")) %>%
  gather(measure, value, bdm_mean, chunking_mean, edge_mean, emd) %>%
  filter(measure != "emd") %>%
  left_join(select(all_data, sub_id, seed) %>% distinct())

mean_data <- individual_data %>%
  group_by(generation, condition, type, measure) %>%
  tidyboot_mean(value)

ggplot(filter(individual_data, measure == "bdm_mean", type == "dyad", condition == "child",
              generation > 0, trialDisplay == 1, seed <= 20), 
       aes(x = generation, y = value, group = generation)) + 
  facet_wrap(~ seed, scales = "free") +
  geom_boxplot()

pdf("complexity_plot.pdf", width = 4, 8)
ggplot(individual_data, aes(x = generation, color = interaction(type,condition)),
       group=interaction(type,condition)) +
  facet_grid( measure ~ ., scales = "free") +
  geom_smooth(method = "loess", span = 1, se = F, aes(y = value), position = position_dodge(.25))+
  geom_pointrange(data = mean_data, aes(ymin = ci_lower, ymax = ci_upper, y = empirical_stat),
                  position = position_dodge(.25)) +
  ylab("algorithmic complexity") + 
  ggtitle("Algorithmic Complexity over Generations") +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none") +
  geom_dl(method = "smart.grid", aes(y = value, label = interaction(type, condition)))
dev.off()
  




  ggplot(aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                      ymax = ci_upper, color = interaction(type,condition),                               group=interaction(type,condition))) + 
  geom_pointrange() + 
  geom_smooth(method = "loess", se = F)+
  ylab("algorithmic complexity") + 
  ggtitle("Algorithmic Complexity over Generations") +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6)) +
  theme(plot.title = element_text(hjust = 0.5))


#seems to be variation by trial display 
all_bind_data %>% 
  filter(type != "dyad") %>%
  group_by(generation, trialDisplay,condition,type) %>% 
  tidyboot_mean(bdm_mean) %>%
  ggplot(aes(x = generation, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper, color = interaction(type,condition))) + 
  geom_pointrange() + 
  geom_smooth(method="loess", aes(group=interaction(type, condition)), se=F)+
  ylab("algorithmic complexity") + 
  facet_wrap(~trialDisplay) + 
  ggtitle("algoritmic complexity over generations by trial display")+
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12))
```

Chunking
```{r chunk_graphs}
all_bind_data  %>%
  filter(type != "baseline" & type != "dyad") %>%
  group_by(generation, type) %>%
  tidyboot_mean(chunking_mean) %>%
  mutate(condition = if_else(floor(generation) != generation, "child", "adult")) %>%
    mutate(type = ifelse(type == "baseline_rep", "learner baseline", ifelse(condition == "child", "learner dyad", "fixer dyad"))) %>%
  ggplot(aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                      ymax = ci_upper, color = type, group=type)) + 
  geom_pointrange() + 
  geom_smooth(span = 0.9, method = "loess", se = F)+
  ylab("# of chunks") + 
  ggtitle("Chunking over Generations") +
    scale_x_continuous(breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12)) +
  theme(plot.title = element_text(hjust = 0.5))

sall_bind_data %>% 
  group_by(generation, trialDisplay,condition,type) %>% 
  tidyboot_mean(chunking_mean) %>%
  ggplot(aes(x = generation, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper, color = interaction(type,condition))) + 
  geom_pointrange() + 
  geom_smooth(method="loess", aes(group=interaction(type, condition)), se=F)+
  ylab("chunking") + 
  facet_wrap(~trialDisplay) + 
  ggtitle("chunking over generations by trial display")+
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6))
```

Edge Length
```{r edge_graph}
all_bind_data  %>%
  filter(type!="baseline" & type != "dyad" ) %>%
  group_by(generation, type) %>%
  tidyboot_mean(edge_mean) %>%
  mutate(condition = if_else(floor(generation) != generation, "child", "adult")) %>%
      mutate(type = ifelse(type == "baseline_rep", "learner baseline", ifelse(condition == "child", "learner dyad", "fixer dyad"))) %>%
  ggplot(aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                      ymax = ci_upper, color = type,group=type)) + 
  geom_pointrange() + 
  geom_smooth(method = "loess", se = F)+
  ylab("edge length") + 
  ggtitle("edge length over generations") +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12)) +
  theme(plot.title = element_text(hjust = 0.5))

all_bind_data %>% 
  group_by(generation, trialDisplay,condition,type) %>% 
  tidyboot_mean(edge_mean) %>%
  ggplot(aes(x = generation, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper, color = interaction(type,condition))) + 
  geom_pointrange() + 
  geom_smooth(method="loess", aes(group=interaction(type, condition)), se=F)+
  ylab("edge length") + 
  facet_wrap(~trialDisplay) + 
  ggtitle("edge length over generations by trial display")+
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6))
```

## Earth-Mover Distance
Earth-Mover Distance is calculated as the number of moves (one move=one direction NSEW) to get from a target pattern to the resultant pattern. 

```{r emd_analysis}
all_bind_data  %>%
  filter(type != "dyad", type != "baseline") %>%
  group_by(generation, type) %>%
  filter(generation > 0, trialDisplay != 6) %>%
  tidyboot_mean(emd) %>%
  mutate(condition = if_else(floor(generation) != generation, "child", "adult")) %>%
  ggplot(aes(x = generation, y = empirical_stat, ymin = ci_lower, 
                      ymax = ci_upper, color = interaction(type,condition),                               group=interaction(type,condition))) + 
  geom_pointrange() + 
  geom_smooth(method = "loess", se = F)+
  ylab("Earth-Mover Distance") + 
  ggtitle("Earth-Mover Distance length over generations") 

all_bind_data %>% 
  filter(generation >0) %>%
  group_by(generation, trialDisplay,condition,type) %>% 
  tidyboot_mean(emd) %>%
  ggplot(aes(x = generation, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper, color = interaction(type,condition))) + 
  geom_pointrange() + 
  geom_smooth(method="loess", aes(group=interaction(type, condition)), se=F)+
  ylab("Earth-Mover Distance") + 
  facet_wrap(~trialDisplay) + 
  ggtitle("Earth-Mover Distance over generations by trial display")+
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6))
```

## Including Seed Information

```{r, include=F, eval=F}
bdm_seed_data <- spread_data %>%
  filter(trialCount > 3, generation != 0, seed != 20) %>%
  select(sub_id=unique_id, generation,seed,trialDisplay, row, input_0:input_7) %>%
  mutate_all(as.numeric) %>%
  arrange(trialDisplay, sub_id)

target_seed_data <- spread_data %>%
  filter(trialDisplay != 0 & trialDisplay != 0.5 & generation == 0 & seed !=20)  %>%
  select(sub_id = unique_id, generation,seed,trialDisplay, row, input_0:input_7) %>%
  mutate_all(as.numeric)  %>%
  select(-(input_0:input_7)) %>%
  arrange(trialDisplay,sub_id) %>%
  unique()
 
target_seed_store <- data.frame(bdm = bdm_seed_function(target_seed_data),
                           chunking = nPart_seed_function(target_seed_data),
                           edge = edge_seed_function(target_seed_data)) 
bdm_seed_store <- data.frame(bdm = bdm_seed_function(bdm_seed_data),
                        chunking = nPart_seed_function(bdm_seed_data),
                        edge = edge_seed_function(bdm_seed_data))

bind_seed_targets <- target_seed_data %>%
  group_by(trialDisplay,sub_id,generation,seed) %>%
  summarise(.) %>%
  bind_cols(target_seed_store, .)

bind_seed_data <- bdm_seed_data %>%
  group_by(trialDisplay, sub_id, generation,seed) %>%
  summarise(.) %>%
  bind_cols(bdm_seed_store, .) %>%
  bind_rows(. , bind_seed_targets) %>%
  mutate_all(as.numeric) %>%
  group_by(sub_id,trialDisplay, generation,seed)%>%
  summarise(bdm_mean = mean(bdm),
            chunking_mean = mean(chunking),
            edge_mean = mean(edge)) 

```

Inlcuding seed information for complexity, chunking, and edge length yields similar results.
```{r seed_graphs, eval=F, include=F}
#shows complexity by seed, see variation but same general trend across seeds 
ggplot(bind_seed_data %>%group_by(generation, seed) %>% tidyboot_mean(bdm_mean), aes(x = generation, y = empirical_stat,  
                       ymin = ci_lower, ymax = ci_upper)) + 
  geom_pointrange()+geom_line()+ylab("algorithmic complexity")+facet_wrap(~seed)+scale_y_continuous(limits = c(160,250))+ggtitle("algorithmic complexity over generations by distinct chain #")

#these trends seem to be more dramatic here! There's one chain that doesn't decrease, but some very dramatic
ggplot(bind_seed_data %>% group_by(generation,seed) %>% tidyboot_mean(chunking_mean), aes(x = generation, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper)) + 
  geom_pointrange()+geom_line()+ylab("number of chunks")+facet_wrap(~seed)+ggtitle("chunking over generations by distinct chain #")

#trends are same
ggplot(bind_seed_data %>% group_by(generation,seed) %>% tidyboot_mean(edge_mean), aes(x = generation, y = empirical_stat, 
                       ymin = ci_lower, ymax = ci_upper)) + 
  geom_pointrange()+geom_line()+ylab("edge length")+facet_wrap(~seed)+ggtitle("edge length over generations by distinct chain #")
```

## Identifiability
Kempe et al defined this as the proportion of within-chain similarity / (within-chain)+(across-chain similarity). 
We will try to define "similarity" two ways: 
  1) as the percent of same cells highlighted (like we did for % accuracy between target/input, but just with input of gen 1 seed 1 compared to input of gen 1 seed 2)
  2) using emd as the measure of similarity (lower emd = more similar, less moves)
  ^ START WITH THIS MEASURE
```{r, include=F, eval = F}
within_helper <- function(df) {
  input <- df %>%
    select(input_0:input_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
  
  target_1 <- df %>%
    select(within_1_0:within_1_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
  
  target_2 <- df %>%
    select(within_2_0:within_2_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
    
  target_3 <- df %>%
    select(within_3_0:within_3_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
      
  target_4 <- df %>%
    select(within_4_0:within_4_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
        
  target_5 <- df %>%
    select(within_5_0:within_5_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix

  data_frame(unique_id = first(df$unique_id),  
             seed = first(df$seed),
             generation = first(df$generation), 
             trialDisplay = first(df$trialDisplay),
             emd_1 = emd2d(input, target_1),
             emd_2 = emd2d(input, target_2),
             emd_3 = emd2d(input, target_3),
             emd_4 = emd2d(input, target_4),
             emd_5 = emd2d(input, target_5))
}
across_helper <- function(df) {
  input <- df %>%
    select(input_0:input_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
  
  target_1 <- df %>%
    select(across_1_0:across_1_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
  
  target_2 <- df %>%
    select(across_2_0:across_2_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
    
  target_3 <- df %>%
    select(across_3_0:across_3_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
      
  target_4 <- df %>%
    select(across_4_0:across_4_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix
        
  target_5 <- df %>%
    select(across_5_0:across_5_7) %>%
    mutate_all(as.numeric) %>%
    as.matrix

  data_frame(unique_id = first(df$unique_id),  
             seed = first(df$seed),
             generation = first(df$generation), 
             trialDisplay = first(df$trialDisplay),
             emd_1 = emd2d(input, target_1),
             emd_2 = emd2d(input, target_2),
             emd_3 = emd2d(input, target_3),
             emd_4 = emd2d(input, target_4),
             emd_5 = emd2d(input, target_5))
}
```

```{r, include = F, eval = F}
ident_within <- spread_data %>%
  arrange(trialDisplay, seed, generation) %>%
  select(unique_id, seed, generation, trialDisplay, row, input_0:input_7) %>%
  filter(generation != 0, trialDisplay >=1) %>% 
  group_by(seed, trialDisplay) %>%
  mutate(within_1_0 = ifelse(is.na(lead(input_0, 8))==F, lead(input_0, 8), lag(input_0,8)), within_1_1 = ifelse(is.na(lead(input_1, 8))==F, lead(input_1, 8), lag(input_1,8)), within_1_2 = ifelse(is.na(lead(input_2, 8))==F, lead(input_2, 8), lag(input_2,8)), within_1_3 = ifelse(is.na(lead(input_3, 8))==F, lead(input_3, 8), lag(input_3,8)), within_1_4 = ifelse(is.na(lead(input_4, 8))==F, lead(input_4, 8), lag(input_4,8)), within_1_5 = ifelse(is.na(lead(input_5, 8))==F, lead(input_5, 8), lag(input_5,8)), within_1_6 = ifelse(is.na(lead(input_6, 8))==F, lead(input_6, 8), lag(input_6,8)),within_1_7 = ifelse(is.na(lead(input_7, 8))==F, lead(input_7, 8), lag(input_7,8)), 
         within_2_0 = ifelse(is.na(lead(within_1_0, 8))==F, lead(within_1_0,8),lag(within_1_0,8)), within_2_1 = ifelse(is.na(lead(within_1_1, 8))==F, lead(within_1_1,8),lag(within_1_1,8)), within_2_2 = ifelse(is.na(lead(within_1_2, 8))==F, lead(within_1_2,8),lag(within_1_2,8)), within_2_3 = ifelse(is.na(lead(within_1_3, 8))==F, lead(within_1_3,8),lag(within_1_3,8)), within_2_4 = ifelse(is.na(lead(within_1_4, 8))==F, lead(within_1_4,8),lag(within_1_4,8)), within_2_5 = ifelse(is.na(lead(within_1_5, 8))==F, lead(within_1_5,8),lag(within_1_5,8)), within_2_6 = ifelse(is.na(lead(within_1_6, 8))==F, lead(within_1_6,8),lag(within_1_6,8)), within_2_7 =  ifelse(is.na(lead(within_1_7, 8))==F, lead(within_1_7,8),lag(within_1_7,8)),
         within_3_0 = ifelse(is.na(lead(within_2_0, 8))==F, lead(within_2_0,8),lag(within_2_0,8)), within_3_1 = ifelse(is.na(lead(within_2_1, 8))==F, lead(within_2_1,8),lag(within_2_1,8)), within_3_2 =ifelse(is.na(lead(within_2_2, 8))==F, lead(within_2_2,8),lag(within_2_2,8)), within_3_3 = ifelse(is.na(lead(within_2_3, 8))==F, lead(within_2_3,8),lag(within_2_3,8)), within_3_4 = ifelse(is.na(lead(within_2_4, 8))==F, lead(within_2_4,8),lag(within_2_4,8)), within_3_5 = ifelse(is.na(lead(within_2_5, 8))==F, lead(within_2_5,8),lag(within_2_5,8)), within_3_6 = ifelse(is.na(lead(within_2_6, 8))==F, lead(within_2_6,8),lag(within_2_6,8)), within_3_7 = ifelse(is.na(lead(within_2_7, 8))==F, lead(within_2_7,8),lag(within_2_7,8)),
         within_4_0 = ifelse(is.na(lead(within_3_0, 8))==F, lead(within_3_0,8),lag(within_3_0,8)), within_4_1 =ifelse(is.na(lead(within_3_1, 8))==F, lead(within_3_1,8),lag(within_3_1,8)), within_4_2 = ifelse(is.na(lead(within_3_2, 8))==F, lead(within_3_2,8),lag(within_3_2,8)), within_4_3 = ifelse(is.na(lead(within_3_3, 8))==F, lead(within_3_3,8),lag(within_3_3,8)), within_4_4 = ifelse(is.na(lead(within_3_4, 8))==F, lead(within_3_4,8),lag(within_3_4,8)),         within_4_5 = ifelse(is.na(lead(within_3_5, 8))==F, lead(within_3_5,8),lag(within_3_5,8)), within_4_6 = ifelse(is.na(lead(within_3_6, 8))==F, lead(within_3_6,8),lag(within_3_6,8)),within_4_7 = ifelse(is.na(lead(within_3_7, 8))==F, lead(within_3_7,8),lag(within_3_7,8)),
         within_5_0 = ifelse(is.na(lead(within_4_0, 8))==F, lead(within_4_0,8),lag(within_4_0,8)), within_5_1 = ifelse(is.na(lead(within_4_1, 8))==F, lead(within_4_1,8),lag(within_4_1,8)), within_5_2 = ifelse(is.na(lead(within_4_2, 8))==F, lead(within_4_2,8),lag(within_4_2,8)), within_5_3 = ifelse(is.na(lead(within_4_3, 8))==F, lead(within_4_3,8),lag(within_4_3,8)), within_5_4 = ifelse(is.na(lead(within_4_4, 8))==F, lead(within_4_4,8),lag(within_4_4,8)),         within_5_5 = ifelse(is.na(lead(within_4_5, 8))==F, lead(within_4_5,8),lag(within_4_5,8)), within_5_6 = ifelse(is.na(lead(within_4_6, 8))==F, lead(within_4_6,8),lag(within_4_6,8)),within_5_7 = ifelse(is.na(lead(within_4_7, 8))==F, lead(within_4_7,8),lag(within_4_7,8))) %>%
  ungroup(.) 

ident_across <- spread_data %>%
  arrange(trialDisplay, generation,seed) %>%
  select(unique_id, seed, generation, trialDisplay, row, input_0:input_7) %>%
  filter(generation != 0, trialDisplay >=1) %>% 
  group_by(generation, trialDisplay) %>%
  mutate(across_1_0 = ifelse(is.na(lead(input_0, 8))==F, lead(input_0, 8), lag(input_0,8)), across_1_1 = ifelse(is.na(lead(input_1, 8))==F, lead(input_1, 8), lag(input_1,8)), across_1_2 = ifelse(is.na(lead(input_2, 8))==F, lead(input_2, 8), lag(input_2,8)), across_1_3 = ifelse(is.na(lead(input_3, 8))==F, lead(input_3, 8), lag(input_3,8)), across_1_4 = ifelse(is.na(lead(input_4, 8))==F, lead(input_4, 8), lag(input_4,8)), across_1_5 = ifelse(is.na(lead(input_5, 8))==F, lead(input_5, 8), lag(input_5,8)), across_1_6 = ifelse(is.na(lead(input_6, 8))==F, lead(input_6, 8), lag(input_6,8)),across_1_7 = ifelse(is.na(lead(input_7, 8))==F, lead(input_7, 8), lag(input_7,8)), 
         across_2_0 = ifelse(is.na(lead(across_1_0, 8))==F, lead(across_1_0,8),lag(across_1_0,8)), across_2_1 = ifelse(is.na(lead(across_1_1, 8))==F, lead(across_1_1,8),lag(across_1_1,8)), across_2_2 = ifelse(is.na(lead(across_1_2, 8))==F, lead(across_1_2,8),lag(across_1_2,8)), across_2_3 = ifelse(is.na(lead(across_1_3, 8))==F, lead(across_1_3,8),lag(across_1_3,8)), across_2_4 = ifelse(is.na(lead(across_1_4, 8))==F, lead(across_1_4,8),lag(across_1_4,8)), across_2_5 = ifelse(is.na(lead(across_1_5, 8))==F, lead(across_1_5,8),lag(across_1_5,8)), across_2_6 = ifelse(is.na(lead(across_1_6, 8))==F, lead(across_1_6,8),lag(across_1_6,8)), across_2_7 =  ifelse(is.na(lead(across_1_7, 8))==F, lead(across_1_7,8),lag(across_1_7,8)),
         across_3_0 = ifelse(is.na(lead(across_2_0, 8))==F, lead(across_2_0,8),lag(across_2_0,8)), across_3_1 = ifelse(is.na(lead(across_2_1, 8))==F, lead(across_2_1,8),lag(across_2_1,8)), across_3_2 =ifelse(is.na(lead(across_2_2, 8))==F, lead(across_2_2,8),lag(across_2_2,8)), across_3_3 = ifelse(is.na(lead(across_2_3, 8))==F, lead(across_2_3,8),lag(across_2_3,8)), across_3_4 = ifelse(is.na(lead(across_2_4, 8))==F, lead(across_2_4,8),lag(across_2_4,8)), across_3_5 = ifelse(is.na(lead(across_2_5, 8))==F, lead(across_2_5,8),lag(across_2_5,8)), across_3_6 = ifelse(is.na(lead(across_2_6, 8))==F, lead(across_2_6,8),lag(across_2_6,8)), across_3_7 = ifelse(is.na(lead(across_2_7, 8))==F, lead(across_2_7,8),lag(across_2_7,8)),
         across_4_0 = ifelse(is.na(lead(across_3_0, 8))==F, lead(across_3_0,8),lag(across_3_0,8)), across_4_1 =ifelse(is.na(lead(across_3_1, 8))==F, lead(across_3_1,8),lag(across_3_1,8)), across_4_2 = ifelse(is.na(lead(across_3_2, 8))==F, lead(across_3_2,8),lag(across_3_2,8)), across_4_3 = ifelse(is.na(lead(across_3_3, 8))==F, lead(across_3_3,8),lag(across_3_3,8)), across_4_4 = ifelse(is.na(lead(across_3_4, 8))==F, lead(across_3_4,8),lag(across_3_4,8)),         across_4_5 = ifelse(is.na(lead(across_3_5, 8))==F, lead(across_3_5,8),lag(across_3_5,8)), across_4_6 = ifelse(is.na(lead(across_3_6, 8))==F, lead(across_3_6,8),lag(across_3_6,8)),across_4_7 = ifelse(is.na(lead(across_3_7, 8))==F, lead(across_3_7,8),lag(across_3_7,8)),
         across_5_0 = ifelse(is.na(lead(across_4_0, 8))==F, lead(across_4_0,8),lag(across_4_0,8)), across_5_1 = ifelse(is.na(lead(across_4_1, 8))==F, lead(across_4_1,8),lag(across_4_1,8)), across_5_2 = ifelse(is.na(lead(across_4_2, 8))==F, lead(across_4_2,8),lag(across_4_2,8)), across_5_3 = ifelse(is.na(lead(across_4_3, 8))==F, lead(across_4_3,8),lag(across_4_3,8)), across_5_4 = ifelse(is.na(lead(across_4_4, 8))==F, lead(across_4_4,8),lag(across_4_4,8)),         across_5_5 = ifelse(is.na(lead(across_4_5, 8))==F, lead(across_4_5,8),lag(across_4_5,8)), across_5_6 = ifelse(is.na(lead(across_4_6, 8))==F, lead(across_4_6,8),lag(across_4_6,8)),across_5_7 = ifelse(is.na(lead(across_4_7, 8))==F, lead(across_4_7,8),lag(across_4_7,8))) %>%
  ungroup(.) 

values_within <- ident_within %>%
  split(paste0(.$unique_id, .$trialDisplay, sep="_")) %>%
  map(within_helper) %>%
  bind_rows() %>%
  arrange(seed, generation, trialDisplay)

values_across <- ident_across %>%
  split(paste0(.$unique_id, .$trialDisplay, sep="_")) %>%
  map(across_helper) %>%
  bind_rows() %>%
  arrange(seed, generation, trialDisplay)

within_data <- values_within %>%
  select(emd_1, emd_2, emd_3, emd_4, emd_5) %>%
  mutate(emd_within_avg = rowMeans(., na.rm=T)) %>%
  merge(.,values_within, by=c("emd_1","emd_2","emd_3","emd_4","emd_5")) %>%
  unique(.) %>%
  arrange(seed, generation, trialDisplay) %>%
  select(unique_id, seed, generation, trialDisplay, emd_1, emd_2, emd_3, emd_4, emd_5, emd_within_avg)

across_data <- values_across %>%
  select(emd_1, emd_2, emd_3, emd_4, emd_5) %>%
  mutate(emd_across_avg = rowMeans(., na.rm=T)) %>%
  merge(.,values_across, by=c("emd_1","emd_2","emd_3","emd_4","emd_5")) %>%
  unique(.) %>%
  arrange(seed, generation, trialDisplay) %>%
  select(unique_id, seed, generation, trialDisplay, emd_1, emd_2, emd_3, emd_4, emd_5, emd_across_avg)



```

```{r ident_analysis, include = F, eval = F}
emds <- spread_data %>%
  filter(generation > 0 & trialCount > 3) %>%
  split(paste0(.$unique_id, .$trialDisplay, sep="_")) %>%
  map(emd_helper) %>%
  bind_rows() 

ggplot(emds, aes(x = emd)) + 
  facet_grid(generation~trialDisplay) + 
  geom_histogram()

generation_emds <- emds %>%
  group_by(generation, trialDisplay) %>%
  tidyboot_mean(emd)

ggplot(generation_emds, aes(x = generation, y = empirical_stat, 
                            ymin = ci_lower, ymax = ci_upper)) +
  facet_wrap(~trialDisplay) + 
  geom_pointrange() + 
  geom_line()
```


## Fixing grids
Want to see how much adults change the input grids they are given. Calculate this by % accuracy from child input to adult input (so you have to edit the data -- be wary!)
```{r}
dyad_data <- turk_dyad %>%
  mutate(target1Array = ifelse(condition =="adult", "1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 1",target1Array),
         target2Array = ifelse(condition =="adult","0 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 1 1 1 0 0 0 0 0",target2Array),
         target3Array = ifelse(condition =="adult", "0 1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1",target3Array),
         target4Array = ifelse(condition =="adult", dyad_pilot$data4Array[match(dyad_pilot$parent_id, dyad_pilot$unique_id)],target4Array),
         target5Array = ifelse(condition =="adult", dyad_pilot$data5Array[match(dyad_pilot$parent_id, dyad_pilot$unique_id)],target5Array),
         target6Array = ifelse(condition =="adult", dyad_pilot$data6Array[match(dyad_pilot$parent_id, dyad_pilot$unique_id)],target6Array),
         target7Array = ifelse(condition =="adult", dyad_pilot$data7Array[match(dyad_pilot$parent_id, dyad_pilot$unique_id)],target7Array),
         target8Array = ifelse(condition =="adult", dyad_pilot$data8Array[match(dyad_pilot$parent_id, dyad_pilot$unique_id)],target8Array),
         targetArray = ifelse(condition =="adult", dyad_pilot$data9Array[match(dyad_pilot$parent_id, dyad_pilot$unique_id)],target9Array))
```

```{r}
dyad <- dyad_data %>%
  select(-(available_onload:available_accepted), -sub_age) %>%
  gather(display, array, -(unique_id:time1Used), -(trial2Count:time2Used),                              -(trial3Count:time3Used),-(trial4Count:time4Used), -(trial5Count:time5Used),                     -(trial6Count:time6Used),-(trial7Count:time7Used), -(trial8Count:time8Used),                     -(trial9Count:time9Used)) %>%
  unique() %>%
  separate(display, c("type", "trialCountArray"), -6) %>%
  separate(trialCountArray, c("trialCount", "arrayCount"), 1) %>%
  gather(trialDisplay, display, -(unique_id:time), -time1Used, -time2Used, -time3Used,-time4Used,       -time5Used, -time6Used, -time7Used, -time8Used, -time9Used,  -type,-trialCount, -array) %>%
  separate(trialDisplay, c("type2", "tmp"), -7) %>%
  separate(type2, c("tmp2", "trialCount2"), -1) %>%
  filter(trialCount2 == trialCount) %>%
  gather(trialTime, timeUsed, -(unique_id:time), -type, -trialCount, -display, -array) %>%
  separate(trialTime, c("tmp", "trialCount3"), -5) %>%
  separate(trialCount3, c("trialCount3", "tmp2"), 1) %>%
  filter(trialCount == trialCount3) %>%
  select(unique_id:time, trialCount, trialDisplay = display, timeUsed, type, array) %>%
  spread(type, array) %>%
  separate(data, input_labs, sep = " ") %>%
  separate(target, target_labs, sep = " ") %>%
  mutate_at(c(input_labs, target_labs, "sub_id", "generation", "seed", "trialCount", "trialDisplay", "timeUsed"), as.numeric) %>%
  mutate(generation = ifelse(condition == "child", generation-0.5, generation))

dyad_calculate_data <-dyad %>%
  gather(row, value,-unique_id:-timeUsed)%>%
  separate(row, c("type","row", "col")) %>%
  spread(type,value) %>%
  mutate(accuracy = input == target, sub_id = as.character(sub_id)) %>%
  arrange(seed, generation) 

```

# of changes people made when fixing grids
Here, accuracy is the number of points that were the same as the child's input. Therefore, number of changes made by the "adult" is 1-accuracy. It looks like people made 2-3 changes on average per trial.
```{r}
fixed2_data <- dyad_calculate_data %>%
  filter(target ==1, generation > 0, trialDisplay >=1) %>%
  filter(condition == "adult") %>%
  group_by(sub_id, trialDisplay) %>%
  mutate(num_changes = sum(ifelse(accuracy ==FALSE, 1, 0)))%>%
 # mutate(accuracy=1-mean(accuracy)) %>%
  group_by(generation) %>%
  tidyboot_mean(num_changes) %>%
  mutate(generation = as.factor(generation))

ggplot(fixed2_data, aes(x= generation, y=empirical_stat, ymin=ci_lower, ymax=ci_upper))+
  geom_pointrange()+
  geom_smooth(method="loess")+
  ggtitle("Average number of changes made when fixing grids")+
  ylab("# of targets that were changed out of 10")
```

